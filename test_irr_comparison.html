<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IRR å¤æŠ•æ•ˆæœå¯¹æ¯”æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Arial', 'Microsoft YaHei', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            font-size: 32px;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        .card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .card h2 {
            font-size: 24px;
            margin-bottom: 15px;
            text-align: center;
        }
        .result {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .improvement {
            background: rgba(16, 185, 129, 0.3);
            border: 2px solid #10b981;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin-top: 20px;
        }
        .params {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .params div {
            margin: 5px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ IRR å¤æŠ•æ•ˆæœå¯¹æ¯”æµ‹è¯•</h1>
        
        <div class="params">
            <h3>æµ‹è¯•å‚æ•°ï¼š</h3>
            <div>ğŸ“Š æˆ¿é—´æ•°é‡ï¼š100 é—´</div>
            <div>ğŸ“ˆ å…¥ä½ç‡ï¼š100%</div>
            <div>ğŸ’° å¹³å‡æˆ¿ä»·ï¼š200 å…ƒ/å¤©</div>
            <div>ğŸ¤ åˆ†æˆæ¯”ä¾‹ï¼š10%</div>
            <div>ğŸ’» è®¾å¤‡æŠ•å…¥ï¼š100 ä¸‡å…ƒ</div>
            <div>ğŸ“… é¢„æœŸå¹´æ”¶ç›Šç‡ï¼š18%</div>
            <div>â° åˆ†è´¦é¢‘ç‡ï¼šæ—¥åˆ†è´¦</div>
        </div>

        <div class="comparison">
            <div class="card">
                <h2>âŒ ä¸è€ƒè™‘å¤æŠ•</h2>
                <div class="result" id="withoutReinvest">è®¡ç®—ä¸­...</div>
                <div style="text-align: center; opacity: 0.8;">ä¼ ç»Ÿ IRR è®¡ç®—æ–¹æ³•</div>
            </div>
            
            <div class="card">
                <h2>âœ… è€ƒè™‘å¤æŠ•</h2>
                <div class="result" id="withReinvest">è®¡ç®—ä¸­...</div>
                <div style="text-align: center; opacity: 0.8;">å¤æŠ• IRR è®¡ç®—æ–¹æ³•</div>
            </div>
        </div>

        <div class="improvement" id="improvement">
            æ­£åœ¨è®¡ç®—æ”¶ç›Šæå‡...
        </div>
    </div>

    <script>
        // æµ‹è¯•å‚æ•°
        const params = {
            roomCount: 100,
            occupancyRate: 1.0,
            avgPrice: 200,
            profitShareRate: 0.10,
            equipmentCost: 100, // ä¸‡å…ƒ
            annualReturn: 0.18
        };

        // è®¡ç®— PCF å’Œ YITO
        const pcfDaily = params.roomCount * params.occupancyRate * params.avgPrice * params.profitShareRate;
        const totalInvestmentYuan = params.equipmentCost * 10000;
        const dailyReturn = params.annualReturn / 365;
        const yitoPeriodDays = Math.round(totalInvestmentYuan / (pcfDaily - totalInvestmentYuan * dailyReturn));

        console.log('æ—¥PCF:', pcfDaily);
        console.log('æ€»æŠ•èµ„:', totalInvestmentYuan);
        console.log('YITOæœŸé™:', yitoPeriodDays, 'å¤©');

        // æ„é€ ç°é‡‘æµ
        function buildDailyCashFlows(days, amount) {
            const flows = [];
            for (let day = 1; day <= days; day++) {
                flows.push({ days: day, amount: amount });
            }
            return flows;
        }

        // IRR è®¡ç®—å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
        function calculateIRR(investment, cashFlows, withReinvest) {
            const maxDays = Math.max(...cashFlows.map(f => f.days));
            const maxYears = maxDays / 365;
            
            let irr = 0.1;
            const maxIter = 1000;
            const tolerance = 1e-8;
            
            for (let iter = 0; iter < maxIter; iter++) {
                let npv = -investment;
                let derivative = 0;
                
                if (withReinvest) {
                    for (const flow of cashFlows) {
                        const t = flow.days / 365;
                        const remainingYears = maxYears - t;
                        const logFactor = Math.log(1 + irr);
                        const compoundFactor = Math.exp(remainingYears * logFactor);
                        const futureValue = flow.amount * compoundFactor;
                        const discountFactor = Math.exp(maxYears * logFactor);
                        npv += futureValue / discountFactor;
                        
                        const derivativeFactor = Math.exp((t + 1) * logFactor);
                        derivative -= (t * flow.amount) / derivativeFactor;
                    }
                } else {
                    for (const flow of cashFlows) {
                        const t = flow.days / 365;
                        const logFactor = Math.log(1 + irr);
                        const factor = Math.exp(t * logFactor);
                        npv += flow.amount / factor;
                        
                        const derivativeFactor = Math.exp((t + 1) * logFactor);
                        derivative -= (t * flow.amount) / derivativeFactor;
                    }
                }
                
                if (Math.abs(derivative) < 1e-10) break;
                
                const irrNew = irr - npv / derivative;
                if (Math.abs(irrNew - irr) < tolerance && Math.abs(npv) < 1e-6) {
                    return irrNew * 100;
                }
                
                irr = Math.max(-0.99, Math.min(10, irrNew));
            }
            
            return irr * 100;
        }

        // æ‰§è¡Œè®¡ç®—
        const cashFlows = buildDailyCashFlows(yitoPeriodDays, pcfDaily);
        
        const irrWithout = calculateIRR(totalInvestmentYuan, cashFlows, false);
        const irrWith = calculateIRR(totalInvestmentYuan, cashFlows, true);
        const improvement = irrWith - irrWithout;

        // æ˜¾ç¤ºç»“æœ
        document.getElementById('withoutReinvest').textContent = irrWithout.toFixed(2) + '%';
        document.getElementById('withReinvest').textContent = irrWith.toFixed(2) + '%';
        document.getElementById('improvement').innerHTML = `
            ğŸš€ å¯ç”¨å¤æŠ•åï¼ŒIRR æå‡ <strong>${improvement.toFixed(2)}%</strong> 
            (ä» ${irrWithout.toFixed(2)}% æå‡åˆ° ${irrWith.toFixed(2)}%)
        `;

        console.log('ä¸è€ƒè™‘å¤æŠ• IRR:', irrWithout.toFixed(2) + '%');
        console.log('è€ƒè™‘å¤æŠ• IRR:', irrWith.toFixed(2) + '%');
        console.log('æå‡å¹…åº¦:', improvement.toFixed(2) + '%');
    </script>
</body>
</html>
