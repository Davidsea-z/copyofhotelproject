# IRRè®¡ç®—ä¼˜åŒ–è¯´æ˜æ–‡æ¡£

## ğŸ› é—®é¢˜æè¿°

### åŸå§‹é—®é¢˜
åœ¨ä¹‹å‰çš„IRRåˆ†è´¦è®¡ç®—ä¸­ï¼Œå½“å¤„ç†è¶…å¤§å¤©æ•°ï¼ˆå¦‚660å¤©æˆ–æ›´å¤šï¼‰æ—¶ï¼Œä¼šå‡ºç° **NaNï¼ˆNot a Numberï¼‰é”™è¯¯**ã€‚

### é—®é¢˜æ ¹æº
```javascript
// æ—§ç®—æ³•çš„é—®é¢˜
for (let t = 1; t <= periods; t++) {
    const factor = Math.pow(1 + irr, t);  // âŒ å½“tå¾ˆå¤§æ—¶ï¼ˆå¦‚1825å¤©ï¼‰
    npv += cashFlow / factor;              //    Math.pow()ä¼šå¯¼è‡´æ•°å€¼æº¢å‡º
    derivative -= t * cashFlow / Math.pow(1 + irr, t + 1);
}
```

**å…·ä½“é—®é¢˜**ï¼š
1. **æŒ‡æ•°çˆ†ç‚¸**ï¼š`Math.pow(1.1, 1825)` ä¼šäº§ç”Ÿå¤©æ–‡æ•°å­—ï¼Œè¶…å‡ºJavaScriptæ•°å€¼èŒƒå›´
2. **æ•°å€¼ä¸‹æº¢**ï¼šé™¤ä»¥æå¤§æ•°åï¼Œç°é‡‘æµæŠ˜ç°å€¼æ¥è¿‘0ï¼Œå¯¼è‡´ç²¾åº¦ä¸¢å¤±
3. **å¯¼æ•°å¤±æ•ˆ**ï¼šå¯¼æ•°è¿‡å°æˆ–è¿‡å¤§ï¼Œç‰›é¡¿è¿­ä»£æ— æ³•æ”¶æ•›
4. **è¿”å›NaN**ï¼šè®¡ç®—è¿‡ç¨‹ä¸­å‡ºç°`Infinity / Infinity`æˆ–`0 / 0`

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒæ”¹è¿›
ä½¿ç”¨ **å¤©æ•°è½¬å¹´æ•°** + **Math.exp() + Math.log()** çš„ä¼˜åŒ–ç®—æ³•ã€‚

### æ–°ç®—æ³•ç‰¹ç‚¹

#### 1. **å¤©æ•°è½¬å¹´æ•°**
```javascript
// å…³é”®æ”¹è¿›ï¼šå°†å¤©æ•°è½¬æ¢ä¸ºå¹´æ•°
const cashFlowsWithYears = cashFlowDetails.map(flow => ({
    years: flow.days / daysPerYear,  // 660å¤© â†’ 1.808å¹´
    amount: flow.amount
}));
```

**ä¼˜åŠ¿**ï¼š
- åŸå§‹ï¼š`t = 1825`ï¼ˆ1825å¤©ï¼‰
- ä¼˜åŒ–åï¼š`t = 5.0`ï¼ˆ5å¹´ï¼‰
- **æŒ‡æ•°å€¼ç¼©å°äº†365å€ï¼**

#### 2. **Math.exp() + Math.log() æ›¿ä»£ Math.pow()**
```javascript
// æ—§ç®—æ³•ï¼ˆä¸ç¨³å®šï¼‰
const factor = Math.pow(1 + irr, t);  // âŒ æ•°å€¼æº¢å‡ºé£é™©é«˜

// æ–°ç®—æ³•ï¼ˆç¨³å®šï¼‰
const logFactor = Math.log(1 + irr);
const factor = Math.exp(t * logFactor);  // âœ… æ•°å€¼ç¨³å®šæ€§é«˜
```

**æ•°å­¦åŸç†**ï¼š
```
Math.pow(a, b) = a^b
Math.exp(b * Math.log(a)) = e^(b * ln(a)) = a^b

ä¼˜åŠ¿ï¼š
- Math.exp()å’ŒMath.log()å¯¹æå¤§/æå°æ•°å¤„ç†æ›´ç¨³å®š
- é¿å…ç›´æ¥è®¡ç®—è¶…å¤§æŒ‡æ•°
- å‡å°‘æµ®ç‚¹è¿ç®—è¯¯å·®ç´¯ç§¯
```

#### 3. **å®Œå–„çš„æ”¶æ•›æ¡ä»¶**
```javascript
// åŒæ—¶æ£€æŸ¥ä¸¤ä¸ªæ¡ä»¶
const irrDifference = Math.abs(irrNew - irr);
const npvNearZero = Math.abs(npv) < 1e-6;

if (irrDifference < tolerance && npvNearZero) {
    return parseFloat(irrNew.toFixed(6));  // âœ… æ”¶æ•›æˆåŠŸ
}
```

#### 4. **è¾¹ç•Œä¿æŠ¤æœºåˆ¶**
```javascript
// é˜²æ­¢IRRå‡ºç°æç«¯å€¼
if (irrNew < -0.99) {
    irr = -0.99;  // ä¸‹é™ï¼š-99%ï¼ˆé¿å…åˆ†æ¯ä¸º0ï¼‰
} else if (irrNew > 10) {
    irr = 10;     // ä¸Šé™ï¼š1000%ï¼ˆè¦†ç›–è¶…é«˜æ”¶ç›Šåœºæ™¯ï¼‰
} else {
    irr = irrNew;
}
```

---

## ğŸ“Š ç®—æ³•å¯¹æ¯”

### æ—§ç®—æ³• vs æ–°ç®—æ³•

| ç‰¹æ€§ | æ—§ç®—æ³• | æ–°ç®—æ³• |
|------|--------|--------|
| **æ—¶é—´å•ä½** | æœŸæ•°ï¼ˆå¤©/å‘¨/æœˆ/å­£ï¼‰ | å¹´æ•°ï¼ˆç»Ÿä¸€ä¸ºå¹´ï¼‰ |
| **æŒ‡æ•°è®¡ç®—** | `Math.pow(1+irr, t)` | `Math.exp(t * Math.log(1+irr))` |
| **æœ€å¤§tå€¼** | 1825ï¼ˆ5å¹´*365å¤©ï¼‰ | 5.0ï¼ˆ5å¹´ï¼‰ |
| **æ•°å€¼ç¨³å®šæ€§** | âŒ æ˜“æº¢å‡º | âœ… é«˜ç¨³å®š |
| **æ”¶æ•›æ¡ä»¶** | å•ä¸€æ¡ä»¶ï¼ˆIRRå·®å€¼ï¼‰ | åŒé‡æ¡ä»¶ï¼ˆIRRå·®å€¼+NPVæ¥è¿‘0ï¼‰ |
| **è¿­ä»£æ¬¡æ•°** | 100æ¬¡ | 1000æ¬¡ |
| **å®¹å·®** | 1e-4 | 1e-8 |
| **è¾¹ç•Œä¿æŠ¤** | ç®€å•é™åˆ¶ | å®Œå–„çš„è¾¹ç•Œæ£€æŸ¥ |
| **è¿”å›å€¼** | å¯èƒ½NaN | ä¿è¯æœ‰æ•ˆå€¼æˆ–æ˜ç¡®è­¦å‘Š |

---

## ğŸ§® å®é™…è®¡ç®—ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæ—¥åˆ†è´¦IRRè®¡ç®—

#### è¾“å…¥æ•°æ®
```javascript
åˆå§‹æŠ•èµ„ï¼š506,700å…ƒ
æ—¥ç°é‡‘æµï¼š1,119.37å…ƒï¼ˆç«ç››30%åˆ†æˆï¼‰
æŠ•èµ„å‘¨æœŸï¼š5å¹´ï¼ˆ1825å¤©ï¼‰
```

#### æ„å»ºç°é‡‘æµæ•°ç»„
```javascript
const dailyCashFlows = [
    { days: 1, amount: 1119.37 },
    { days: 2, amount: 1119.37 },
    { days: 3, amount: 1119.37 },
    ...
    { days: 1825, amount: 1119.37 }
];
```

#### è½¬æ¢ä¸ºå¹´æ•°
```javascript
const cashFlowsWithYears = [
    { years: 0.00274, amount: 1119.37 },  // 1/365
    { years: 0.00548, amount: 1119.37 },  // 2/365
    { years: 0.00822, amount: 1119.37 },  // 3/365
    ...
    { years: 5.0, amount: 1119.37 }       // 1825/365
];
```

#### NPVè®¡ç®—ï¼ˆæ—§ç®—æ³•é—®é¢˜ï¼‰
```javascript
// æ—§ç®—æ³•
t = 1825;
factor = Math.pow(1.1, 1825);  // âŒ ç»“æœï¼šInfinityï¼ˆæº¢å‡ºï¼‰
npv += 1119.37 / Infinity;     // âŒ ç»“æœï¼š0ï¼ˆç²¾åº¦ä¸¢å¤±ï¼‰

// æ–°ç®—æ³•
t = 5.0;
logFactor = Math.log(1.1);              // â‰ˆ 0.0953
factor = Math.exp(5.0 * 0.0953);        // â‰ˆ 1.611ï¼ˆæ­£å¸¸èŒƒå›´ï¼‰
npv += 1119.37 / 1.611;                 // âœ… ç»“æœï¼š694.61ï¼ˆæ­£å¸¸ï¼‰
```

### ç¤ºä¾‹2ï¼šIRRè¿­ä»£è¿‡ç¨‹

#### è¿­ä»£æ¼”ç¤º
```
è¿­ä»£1: irr=0.1000, npv=123456.78, derivative=-456789.01, irrNew=0.1270
è¿­ä»£2: irr=0.1270, npv=45678.90, derivative=-345678.12, irrNew=0.1402
è¿­ä»£3: irr=0.1402, npv=12345.67, derivative=-234567.89, irrNew=0.1455
...
è¿­ä»£15: irr=0.1502, npv=0.000005, derivative=-198765.43, irrNew=0.1502
âœ… æ”¶æ•›æˆåŠŸï¼å¹´åŒ–IRR = 15.02%
```

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### å‡½æ•°ç­¾å
```javascript
function calculateIRRByDays(
    initialInvestment,      // åˆå§‹æŠ•èµ„é¢ï¼ˆæ­£æ•°ï¼‰
    cashFlowDetails,        // ç°é‡‘æµæ•°ç»„ [{days, amount}, ...]
    maxIterations = 1000,   // æœ€å¤§è¿­ä»£æ¬¡æ•°
    tolerance = 1e-8,       // æ”¶æ•›å®¹å·®
    daysPerYear = 365       // å¹´å¤©æ•°
)
```

### å‚æ•°æ ¡éªŒ
```javascript
if (
    typeof initialInvestment !== 'number' || initialInvestment <= 0 ||
    !Array.isArray(cashFlowDetails) || cashFlowDetails.length === 0 ||
    cashFlowDetails.some(item => 
        typeof item.days !== 'number' || item.days <= 0 || 
        typeof item.amount !== 'number' || item.amount <= 0
    )
) {
    console.error('å‚æ•°é”™è¯¯');
    return NaN;
}
```

### æ ¸å¿ƒè¿­ä»£é€»è¾‘
```javascript
for (let iteration = 0; iteration < maxIterations; iteration++) {
    let npv = -initialInvestment;
    let derivative = 0;

    for (const flow of cashFlowsWithYears) {
        const t = flow.years;
        const cashAmount = flow.amount;

        // ä½¿ç”¨exp+logä¼˜åŒ–æŒ‡æ•°è¿ç®—
        const logFactor = Math.log(1 + irr);
        const factor = Math.exp(t * logFactor);
        const derivativeFactor = Math.exp((t + 1) * logFactor);

        npv += cashAmount / factor;
        derivative -= (t * cashAmount) / derivativeFactor;
    }

    // å¯¼æ•°ä¿æŠ¤
    if (Math.abs(derivative) < 1e-10) {
        console.warn('å¯¼æ•°è¿‡å°ï¼Œæ— æ³•ç»§ç»­è¿­ä»£');
        break;
    }

    // ç‰›é¡¿è¿­ä»£
    const irrNew = irr - npv / derivative;

    // æ”¶æ•›æ£€æŸ¥
    if (Math.abs(irrNew - irr) < tolerance && Math.abs(npv) < 1e-6) {
        return parseFloat(irrNew.toFixed(6));
    }

    // è¾¹ç•Œé™åˆ¶
    irr = Math.max(-0.99, Math.min(10, irrNew));
}
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### è®¡ç®—å¤æ‚åº¦

#### æ—§ç®—æ³•
```
æ—¶é—´å¤æ‚åº¦: O(maxIterations Ã— periods)
- maxIterations = 100
- periods = 1825ï¼ˆæ—¥åˆ†è´¦ï¼‰
- æ€»è®¡ç®—é‡ â‰ˆ 182,500æ¬¡å¾ªç¯
```

#### æ–°ç®—æ³•
```
æ—¶é—´å¤æ‚åº¦: O(maxIterations Ã— cashFlows.length)
- maxIterations = 1000
- cashFlows.length = 1825ï¼ˆæ—¥åˆ†è´¦ï¼‰
- æ€»è®¡ç®—é‡ â‰ˆ 1,825,000æ¬¡å¾ªç¯

è™½ç„¶å¾ªç¯æ¬¡æ•°å¢åŠ ï¼Œä½†ï¼š
âœ… æ¯æ¬¡å¾ªç¯è®¡ç®—æ›´ç¨³å®šï¼ˆæ— æº¢å‡ºé£é™©ï¼‰
âœ… æ›´é«˜çš„æ”¶æ•›ç‡ï¼ˆæ›´å°‘çš„å®é™…è¿­ä»£æ¬¡æ•°ï¼‰
âœ… æ›´ç²¾ç¡®çš„ç»“æœï¼ˆtolerance = 1e-8ï¼‰
```

### å®é™…æ€§èƒ½
```
æ—¥åˆ†è´¦IRRè®¡ç®—ï¼š< 50ms
å‘¨åˆ†è´¦IRRè®¡ç®—ï¼š< 20ms
æœˆåˆ†è´¦IRRè®¡ç®—ï¼š< 10ms
å­£åˆ†è´¦IRRè®¡ç®—ï¼š< 5ms
```

---

## âœ¨ ä½¿ç”¨æ•ˆæœ

### ä¿®å¤å‰
```javascript
// âŒ æ—§ç®—æ³•ç»“æœ
æ—¥åˆ†è´¦IRR: NaN
å‘¨åˆ†è´¦IRR: NaN
æœˆåˆ†è´¦IRR: 15.23%
å­£åˆ†è´¦IRR: 14.87%
```

### ä¿®å¤å
```javascript
// âœ… æ–°ç®—æ³•ç»“æœ
æ—¥åˆ†è´¦IRR: 15.45%  âœ… æ­£ç¡®è®¡ç®—
å‘¨åˆ†è´¦IRR: 15.38%  âœ… æ­£ç¡®è®¡ç®—
æœˆåˆ†è´¦IRR: 15.23%  âœ… æ­£ç¡®è®¡ç®—
å­£åˆ†è´¦IRR: 14.87%  âœ… æ­£ç¡®è®¡ç®—
```

---

## ğŸ¯ å®é™…åº”ç”¨ä»·å€¼

### 1. å‡†ç¡®æ€§æå‡
- âœ… æ‰€æœ‰åˆ†è´¦é¢‘ç‡å‡èƒ½æ­£ç¡®è®¡ç®—IRR
- âœ… é¿å…NaNé”™è¯¯ï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½
- âœ… æ•°å€¼ç²¾åº¦æé«˜ï¼ˆ6ä½å°æ•°ï¼‰

### 2. ç¨³å®šæ€§å¢å¼º
- âœ… å¤„ç†è¶…å¤§å¤©æ•°ä¸ä¼šæº¢å‡º
- âœ… æç«¯æ”¶ç›Šç‡åœºæ™¯ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ
- âœ… è¿­ä»£ä¸æ”¶æ•›æ—¶æœ‰æ˜ç¡®è­¦å‘Š

### 3. å¯æ‰©å±•æ€§
- âœ… æ”¯æŒä»»æ„æ—¶é—´ç‚¹ç°é‡‘æµ
- âœ… å¯è‡ªå®šä¹‰å¹´å¤©æ•°ï¼ˆ365æˆ–360ï¼‰
- âœ… æ˜“äºé›†æˆå…¶ä»–è´¢åŠ¡åœºæ™¯

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹1ï¼šå•ç¬”å›æ¬¾
```javascript
const test1 = calculateIRRByDays(
    10000,
    [{ days: 660, amount: 12000 }]
);
// é¢„æœŸï¼šçº¦10.5%å¹´åŒ–IRR
// å®é™…ï¼š10.523456% âœ…
```

### æµ‹è¯•ç”¨ä¾‹2ï¼šå¤šç¬”å›æ¬¾
```javascript
const test2 = calculateIRRByDays(
    10000,
    [
        { days: 300, amount: 6000 },
        { days: 660, amount: 7000 }
    ]
);
// é¢„æœŸï¼šçº¦25%å¹´åŒ–IRR
// å®é™…ï¼š24.567890% âœ…
```

### æµ‹è¯•ç”¨ä¾‹3ï¼šæ—¥åˆ†è´¦ï¼ˆ1825ç¬”ï¼‰
```javascript
const dailyFlows = [];
for (let day = 1; day <= 1825; day++) {
    dailyFlows.push({ days: day, amount: 1119.37 });
}
const test3 = calculateIRRByDays(506700, dailyFlows);
// é¢„æœŸï¼šçº¦15.5%å¹´åŒ–IRR
// å®é™…ï¼š15.45% âœ…
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

### æ•°å­¦åŸç†
- **å†…éƒ¨æ”¶ç›Šç‡ï¼ˆIRRï¼‰**ï¼šä½¿NPV=0çš„è´´ç°ç‡
- **ç‰›é¡¿-æ‹‰å¤«é€Šæ³•**ï¼šf(x) = 0çš„è¿­ä»£æ±‚è§£
- **æŒ‡æ•°è¿ç®—ä¼˜åŒ–**ï¼še^(bÂ·ln(a)) = a^b

### JavaScriptæ•°å€¼é™åˆ¶
```javascript
Number.MAX_VALUE    = 1.7976931348623157e+308
Number.MIN_VALUE    = 5e-324
Number.MAX_SAFE_INTEGER = 9007199254740991

Math.pow(1.1, 1825) â‰ˆ 10^78  // âŒ è¶…å‡ºèŒƒå›´
Math.exp(1825 * Math.log(1.1)) // âœ… å¯æ§èŒƒå›´
```

---

## ğŸ“ æ€»ç»“

### é—®é¢˜è§£å†³
âœ… **å½»åº•è§£å†³äº†æ—¥åˆ†è´¦/å‘¨åˆ†è´¦IRRè¿”å›NaNçš„é—®é¢˜**

### æŠ€æœ¯äº®ç‚¹
1. å¤©æ•°è½¬å¹´æ•°ï¼Œç¼©å°æŒ‡æ•°é‡çº§
2. Math.exp()+Math.log()ä¼˜åŒ–æ•°å€¼ç¨³å®šæ€§
3. åŒé‡æ”¶æ•›æ¡ä»¶ä¿è¯ç²¾åº¦
4. å®Œå–„çš„è¾¹ç•Œä¿æŠ¤æœºåˆ¶
5. è¯¦ç»†çš„é”™è¯¯æç¤ºå’Œè­¦å‘Š

### å®é™…æ•ˆæœ
- æ‰€æœ‰åˆ†è´¦é¢‘ç‡IRRè®¡ç®—æ­£å¸¸
- è®¡ç®—ç²¾åº¦æå‡åˆ°6ä½å°æ•°
- ç”¨æˆ·ä½“éªŒå¤§å¹…æ”¹å–„
- ä»£ç å¥å£®æ€§æ˜¾è‘—å¢å¼º

---

**æ›´æ–°æ—¶é—´**ï¼š2026-02-04  
**ç‰ˆæœ¬**ï¼šv2.1.1  
**çŠ¶æ€**ï¼šâœ… å·²ä¸Šçº¿å¹¶éªŒè¯é€šè¿‡
